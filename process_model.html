<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Process</title>
    <style>
        html {
            box-sizing: border-box;
            font-family: sans-serif;
            font-size: 10pt;
        }

        *,
        *:before,
        *:after {
            box-sizing: inherit;
        }

        body {
            margin: 0;
            overflow: hidden;
        }

        table,
        th,
        td {
            border-collapse: collapse;
            border: 1px solid gray;
        }

        th,
        td {
            padding: 2px 5px;
        }

        #command-input {
            position: fixed;
            top: 1em;
            left: 50%;
            transform: translateX(-50%);
            min-width: 20em;
            outline: none;
            border: 1px solid gray;
            border-radius: 1em;
            background: white;
            box-shadow: 2px 3px 5px #333;
        }
    </style>
</head>

<body>
    <div id="output">Hello<br></div>

    <datalist id="command-list"></datalist>
    <input id="command-input" type="text" list="command-list" autocorrect="off" autocapitalize="off" />

    <script>
        // Activity States
        const waiting = new Symbol('waiting');
        const running = new Symbol('running');
        const blocked = new Symbol('blocked');


        const app = {
            model: {
                processes: [],
                activities: [],
                entities: [],
                links: [],

                addActivity(name) {
                    this.model.activities.push({ name, state: waiting });
                },
            },
            simulation: {
                state: 'paused',
            },

            selected: [],

        };

        /**
         * Utility function to support downloading generated content.
         */
        function saveText(text, name = '') {
            const link = document.createElement('a');
            link.style.display = 'none';
            link.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            link.setAttribute('download', name);

            document.body.appendChild(link);
            link.click();
            link.remove();
        }


        /**
         * Utility function to support loading a file.
         */
        function load() {
            const elem = document.createElement('input');
            elem.type = 'file';
            elem.accept = '.json';
            elem.addEventListener('cancel', () => {
                console.log('Cancelled.');
            });

            function loadFile(file) {
                const reader = new FileReader();
                reader.addEventListener('load', (event) => {
                    const filename = file.name;
                    try {
                        app.model = JSON.parse(reader.result);
                        appendLine(`Loaded ${filename}`);
                    } catch (error) {
                        appendLine(error.message);
                    }
                });
                reader.readAsText(file);
            }

            elem.addEventListener('change', () => {
                if (elem.files.length === 1) {
                    console.log('File selected: ', elem.files[0]);
                    for (let i = 0; i < elem.files.length; ++i) {
                        loadFile(elem.files[i]);
                    }
                }
            });
            elem.click();
        }


        /**
         * Utility function to support downloading generated content.
         */
        function download(text, name = '') {
            const link = document.createElement('a');
            link.style.display = 'none';
            link.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            link.setAttribute('download', name);

            document.body.appendChild(link);
            link.click();
            link.remove();
        }


        /**
         * Common Functions for use by commands
         */

        /**
         * Reset the parse
         */
        function reset() {
            this.chars = this.name.split('');
            return this;
        }

        /**
         * Check the next character against the command
         */
        function parse(i) {
            return this.chars.length === 0 || this.chars.shift() === i;
        }

        /**
         * Add a list to the output
         */
        function appendLine(line) {
            const output = document.getElementById('output');
            output.append(line, document.createElement('br'));
        }

        /**
         * Add a list to the output
         */
        function showList(list) {
            const output = document.getElementById('output');
            output.append(...list.flatMap((item) => [item, document.createElement('br')]));
        }


        /**
         * User commands that can be used in the input box.
         */
        const commands = [
            {
                name: 'load',
                action(str) {
                    load();
                },
                reset,
                parse,
            },
            {
                name: 'save',
                action(str) {
                    saveText(JSON.stringify(app.model, null, 2), 'process_model.json');
                },
                reset,
                parse,
            },
            {
                name: 'clear',
                action(str) {
                    const output = document.getElementById('output');
                    output.innerHTML = '';
                },
                reset,
                parse,
            },
            {
                name: 'add process',
                action(str) {
                    const parameters = str.replace(this.name, '');
                    const name = parameters.trim();
                    app.model.processes.push({ name });
                    appendLine(`Added process: ${name}`);
                },
                reset,
                parse,
            },
            {
                name: 'processes',
                action(str) {
                    const parameters = str.replace(this.name, '');
                    const pattern = parameters.trim();
                    if (pattern === '') {
                        showList(app.model.processes.map((process) => process.name));
                    } else {
                        const expr = new RegExp(pattern);
                        showList(app.model.processes.filter((process) => expr.test(process.name))
                            .map((process) => process.name));
                    }
                },
                reset,
                parse,
            },
            {
                name: 'add activity',
                action(str) {
                    const parameters = str.replace(this.name, '');
                    const name = parameters.trim();
                    app.model.addActivity(name);
                    appendLine(`Added activity: ${name}`);
                },
                reset,
                parse,
            },
            {
                name: 'activities',
                action(str) {
                    const parameters = str.replace(this.name, '');
                    const pattern = parameters.trim();
                    if (pattern === '') {
                        showList(app.model.activities.map((activity) => activity.name));
                    } else {
                        const expr = new RegExp(pattern);
                        showList(app.model.activities.filter((activity) => expr.test(activity.name))
                            .map((activity) => activity.name));
                    }
                },
                reset,
                parse,
            },
            {
                name: 'add entity',
                action(str) {
                    const parameters = str.replace(this.name, '');
                    const name = parameters.trim();
                    app.model.entities.push({ name });
                    appendLine(`Added entity: ${name}`);
                },
                reset,
                parse,
            },
            {
                name: 'entities',
                action(str) {
                    const parameters = str.replace(this.name, '');
                    const pattern = parameters.trim();
                    if (pattern === '') {
                        showList(app.model.entities.map((entity) => entity.name));
                    } else {
                        const expr = new RegExp(pattern);
                        showList(app.model.entities.filter((entity) => expr.test(entity.name))
                            .map((entity) => entity.name));
                    }
                },
                reset,
                parse,
            },
            {
                name: 'draw',
                action(str) {
                    const parameters = str.replace(this.name, '');
                    const pattern = parameters.trim();
                    if (pattern === '') {
                        if (app.selected.length > 0) {
                            draw(app.selected);
                        } else {
                            draw([...app.model.processes, ...app.model.activities, ...app.model.entities, ...app.model.links]);
                        }
                    } else {

                    }
                },
                reset,
                parse,
            },
            {
                name: 'none',
                action(str) {
                    app.model.length = 0;
                },
                reset,
                parse,
            },
            {
                name: 'selected',
                action(str) {
                    const parameters = str.replace(this.name, '');
                    const pattern = parameters.trim();
                    if (pattern === '') {
                        showList(app.selected.map((item) => item.name));
                    } else {
                        const expr = new RegExp(pattern);
                        showList(app.selected.filter((item) => expr.test(item.name))
                            .map((item) => item.name));
                    }
                },
                reset,
                parse,
            },
            {
                name: 'commands',
                action(str) {
                    const parameters = str.replace(this.name, '');
                    const pattern = parameters.trim();
                    if (pattern === '') {
                        showList(commands.map((command) => command.name));
                    } else {
                        const expr = new RegExp(pattern);
                        showList(commands.filter((command) => expr.test(command.name))
                            .map((command) => command.name));
                    }
                },
                reset,
                parse,
            },
        ];

        /**
         * Update the command list for completions.
         */
        function updateCommandList() {
            const commandList = document.getElementById('command-list');
            commandList.innerHTML = commands.map((command) => `<option>${command.name}</option>`).join('');
        }


        /**
         * Handle a command entered in the input box.
         */
        function processCommand(event) {
            const input = document.getElementById('command-input');

            let validCommands = commands.map((command) => command.reset());
            const command = input.value.split('');

            const parse = (i) => validCommands = validCommands.filter((command) => command.parse(i));

            while (validCommands.length > 0 && command.length > 0) {
                parse(command.shift());
            }
            if (validCommands.length === 1) {
                validCommands[0].action(input.value);
            } else {
                const process = app.model.processes.find((process) => process.name === input.value);
                const activity = app.model.activities.find((activity) => activity.name === input.value);
                const entity = app.model.entities.find((entity) => entity.name === input.value);

                if (process) {
                    app.selected.push(process);
                    appendLine(`Selected process: ${process.name}`);
                }
                if (activity) {
                    app.selected.push(activity);
                    appendLine(`Selected activity: ${activity.name}`);
                }
                if (entity) {
                    app.selected.push(entity);
                    appendLine(`Selected entity: ${entity.name}`);
                }
                const output = document.getElementById('output');
                output.append(input.value, document.createElement('br'));
            }

            if (event.ctrlKey) {
                history.content[history.position++] = input.value;
                input.value = history.content[history.position] || '';
            } else if (event.shiftKey) {
                input.value = '';
                history.position = -1;
            } else {
                history.content.push(input.value);
                history.position = -1;
                input.value = '';
            }
        }

        const history = {
            position: -1,
            content: [],
        }

        /**
         * Validate the content of the input box.
         */
        function processKey(event) {
            const input = document.getElementById('command-input');

            if (event.key === 'Enter') {
                processCommand(event);
            } else if (event.key === 'Escape') {
                document.body.focus();
            } else if (event.key === 'ArrowUp') {
                if (history.position === -1) {
                    history.position = history.content.length - 1;
                    history.content.push(input.value);
                    input.value = history.content[history.position];
                } else {
                    history.position = (history.content.length - 1 + history.position) % history.content.length;
                    input.value = history.content[history.position];
                }
            } else if (event.key === 'DownUp') {
                if (history.position === -1) {
                    history.content.push(input.value);
                }
                history.position = (history.content.length + 1 + history.position) % history.content.length;
                input.value = history.content[history.position];
            }
        }




        const input = document.getElementById('command-input');
        //input.addEventListener('change', processCommand);
        input.addEventListener('keydown', processKey);

        //updateCommandList();

        input.focus();
    </script>
</body>

</html>