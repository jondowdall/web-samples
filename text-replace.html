<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width" />
    <title>Replace Text</title>
    <style>
        html {
            font-family: sans-serif;
            box-sizing: border-box;
        }

        *,
        *:before,
        *:after {
            box-sizing: inherit;
        }

        body {
            margin: 0;
            width: 100vw;
            height: 100dvh;
            padding: 0.25rem;
            background-color: lightgray;
            position: relative;
        }

        textarea {
            width: 100%;
            height: 10em;
            resize: vertical;
        }
        
        .output {
            resize: vertical;
            overflow: auto;
        }
    </style>
</head>

<body>
    <h1>Simple Text Replacement</h1>
    <h2>Source Text</h2>
    <div id="input-controls">
        <button class="back">&larr;</button>
        <button class="forward">&rarr;</button>
    </div>
    <textarea id="input"></textarea>
    <h2>Pattern</h2>
    <div id="pattern-controls">
        <button class="back">&larr;</button>
        <button class="forward">&rarr;</button>
    </div>
    <textarea id="pattern"></textarea>
    <h2>Replacement Function</h2>
    <div id="replacer-controls">
        <button class="back">&larr;</button>
        <button class="forward">&rarr;</button>
    </div>
    <textarea id="replacer"></textarea>
    <div id="controls">
        <button id="replace">Replace</button>
        <button id="use">Use</button>
        <span id="message"></span>
    </div>
    <pre id="output"></pre>

    <script>
        class History {
            constructor() {
                  this.content = [];
                  this.position = 0;
              }
              add(value) {
                  if (value === this.content[this.content.length -1]) {
                      return;
                  }
                  this.content.length = this.position;
                  this.content.push(value);
                  this.position = this.content.length;
              }
              back() {
                  this.postion -= 1;
                  if (this.position < 1) {
                      this.position = this.content.length;
                  }
                  return this.content[this.position - 1];
              }
              forward() {
                  this.position += 1;
                  if (this.position > this.content.length) {
                      this.position = 1;
                  }
                  return this.content[this.position - 1];
              }
          }
      
          const inputHistory = new History();
          const patternHistory = new History();
          const replacerHistory = new History();
    
        const inputNode = document.getElementById('input');
        const patternNode = document.getElementById('pattern');
        const replacerNode = document.getElementById('replacer');
        const replaceButton = document.getElementById('replace');
        const useButton = document.getElementById('use');
        const messageNode = document.getElementById('message');
        const outputNode = document.getElementById('output');

        replaceButton.addEventListener('click', (event) => {
            messageNode.innerText = '';
            const input = inputNode.value;
            const context = { count: 0 };
            try {
                const pattern = new RegExp(patternNode.value, 'g');
                const replacer = new Function('context', 'match', 'parts', 'offset', 'string',
                    replacerNode.value);
                outputNode.innerText = input.replaceAll(pattern, (match, ...parts) => {
                    const [offset, string] = parts.splice(-2, 2);
                    context.count++;
                    return replacer(context, match, parts, offset, string);
                });
            } catch (error) {
                messageNode.innerText = error.message;
            }

            
            patternHistory.add(patternNode.value);
            replacerHistory.add(replacer.value);
        });

        useButton.addEventListener('click', (event) => {
            inputHistory.add(inputNode.Value);
            inputNode.value = outputNode.innerText;
        });

        function saveState() {
            const state = {
                input: inputNode.value,
                inputHistory: inputHistory.content,
                pattern: patternNode.value,
                patternHistory: patternHistory.content,
                replacer: replacerNode.value,
                replacerHistory: replacerHistory.content,
                output: outputNode.innerText,
            }
            localStorage.setItem('text-replace-state', JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem('text-replace-state');
            if (savedState) {
                const state = JSON.parse(savedState);
                inputNode.value = state.input;
                inputHistory.content = state.inputHistory;
                patternNode.value = state.pattern;
                patternHistory.content = state.inputHistory;
                replacerNode.value = state.replacer;
                replacerHistory.content = state.replacerHistory;
                outputNode.innerText = state.output;
            }
        }

        const historyControls = [
            [inputHistory, inputNode, 'input-controls'],
            [patternHistory, patternNode, 'pattern-controls'],
            [replacerHistory, replacerNode, 'replacer-controls']];
        historyControls.forEach((control) => {
            const backButton = document.querySelector(`#{control[2]} .back`);
            const forwardButton = document.querySelector(`#{control[2]} .forward`);
            backButton.addEventListener('click',
                (event) => controls[1].value = controls[0].back());
            forwardButton.addEventListener('click',
                (event) => controls[1].value = controls[0].forward());
        }); 

        window.addEventListener('load', (event) => loadState());
        inputNode.addEventListener('input', (event) => saveState());
        patternNode.addEventListener('input', (event) => saveState());
        replacerNode.addEventListener('input', (event) => saveState());
    </script>
</body>
</html>